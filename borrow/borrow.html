<!DOCTYPE html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
    <meta charset="utf8">
</head>

<p>已借书籍</p>
<div id="result" v-if="show">
    <table border="1">
        <tr>
            <th>ID</th>
            <th>类别</th>
            <th>书名</th>
            <th>出版社</th>
            <th>年份</th>
            <th>作者</th>
            <th>价格</th>
            <th>数量</th>
        </tr>
        <tr v-for="book in books">
            <th>{{ book.bno}}</th>
            <th>{{ book.category}}</th>
            <th>{{ book.title}}</th>
            <th>{{ book.press }}</th>
            <th>{{ book.year }}</th>
            <th>{{ book.author }}</th>
            <th>{{ book.price }}</th>
            <th>{{ book.total }}</th>
            <th><button onclick="returnBook(this)">归还该书</button></th>
        </tr>
    </table>
</div>

<script>
    function getUrlPara()
　　{
　　　　var url = document.location.toString()
　　　　var arrUrl = url.split("?")

　　　　var para = arrUrl[1]
　　　　return para.substr(3, para.length - 3)
　　}

    function returnBook(button){
        let book_id = button.parentNode.parentNode.children[0].outerText
        let card_id = getUrlPara()
        let request = new XMLHttpRequest()
        request.onreadystatechange = () => {
                if(request.readyState == 4)
                {
                    location.reload(true)
                }
            }
        request.open("POST", "/borrow/return",true)
        request.send(JSON.stringify({
            bno: book_id,
            cno: card_id
        }))
    }
        
    let main_window = new Vue({
        el: '#result',
        data: {
            show : true,
            books : []
        },
        created : function(){
            console.log("created")
            let request = new XMLHttpRequest()
            request.onreadystatechange = () => {
                if(request.readyState == 4)
                {
                    let data = JSON.parse(request.responseText)
                    this.books = data.returnData 
                }
            }
            let para = getUrlPara();

            request.open("POST", "/borrow/lookup",true)
            request.send(JSON.stringify({
                id : para
            }))}
    })
</script>