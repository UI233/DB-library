<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
<style>
p.menu
{
    text-align: center;
}

.dialog_mask {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}
.dialog_container {
    background: #fff;
    width: 300px;
    height: 120px;
    position: relative;
    border-radius: 10px;
    margin: 0 auto;
}
.dialog_content {
    text-align: center;
    padding-top: 30px;
}
.dialog_btn {
    margin-top: 20px;
}
.dialog_btn a {
    background: yellow;
    padding: 2px 30px;
    border-radius: 5px;
    color: #fff;
    text-decoration: none;
    width: 50px;
    display: inline-block;
}
.dialog_btn a:nth-child(2) {
    margin-left: 20px;
}
</style>

<template id="dialog">
    <div class="dialog" v-if="isShow">
    <div class="dialog_mask"></div>
    <div class="dialog_container">
        <div class="dialog_content">
        <div class="dialog_btn">
            <input type="text" placeholder="请输入账号" name="username" pattern="[0-9A-z]+">
            <input type="password" v-if="needPass" placeholder="请输入密码" name="passwd" pattern="[0-9A-z]+">
            <br>
            <button @click="submit">登录</button>
            <button @click="cancel">取消</button>
        </div>
        </div>
    </div>
    </div>
</template>

<script>
Vue.component("v-dialog", {
    template: "#dialog",
    props: {
    name: String,
    isShow: {
        type: Boolean,
        default: false
    },
    needPass : {
        type : Boolean,
        default : true
    }
    },
    methods: {
    cancel: function() {
        this.$emit("close-diag");
    },
    submit: function() {
        this.$emit("log-in")
    }
    },
    created: function() {}
})

</script>
        
    
<style type="text/css">
</style>
</head>

<body>
    <v-dialog id="managerid" @close-diag="close" :is-show="show" @log-in="log"></v-dialog>
    <v-dialog id="cardid" @close-diag="close" :is-show="show" @log-in="log" :need-pass="pass"></v-dialog>
    <div id = "menu">
        <p id = "manager" class="menu" @click = "pop">
            <button>管理员登陆</button>
        </p>
        <p id = "card" class="menu" @click = "pop">
            <button>借书/还书</button>
        </p>
        <p id = "book" class="menu">
            <button onclick="window.location.href = '/book'">书目查询</button>
        </p>
    </div>
</body>

<script>
    let dialogue = new Vue(
        {
            el : "#managerid",
            data : {
                show : false
            },
            methods : 
            {
                close : function(){
                    this.show = false
                },
                log : function(){
                    let user = document.getElementsByName("username")[0].value;
                    let passwd = document.getElementsByName("passwd")[0].value;
                    let user_name_pattern = new RegExp(document.getElementsByName("username")[0].pattern)
                    let passwd_pattern = new RegExp(document.getElementsByName("passwd")[0].pattern);

                    if(!user_name_pattern.test(user) || !passwd_pattern.test(passwd))
                    {
                        alert("密码或账号格式错误")
                        return 
                    }

                    let xmlhttp = new XMLHttpRequest()
                    xmlhttp.onreadystatechange = function(){
                        if(xmlhttp.readyState == 4)
                        {
                            if(xmlhttp.responseText == 'false')
                                alert("账号或密码错误")
                            else window.location.href = "/manager.html"
                        }
                    }

                    xmlhttp.open("POST", "/managerLogin", true)
                    xmlhttp.send(JSON.stringify({
                        id : user,
                        password : passwd
                    }))
                }
            }
        }
    )

    let borrow = new Vue({
        el : "#cardid",
        data : {
            show : false,
            pass : false
        },
        methods : {
            close : function(){
                this.show = false
            },
            log : function(){
                let request = new XMLHttpRequest()
                let id = document.getElementsByName("username")[0].value
                let user_name_pattern = new RegExp(document.getElementsByName("username")[0].pattern)
                if(!user_name_pattern.test(id))
                {
                    alert("借记卡格式错误")
                    return 
                }
                request.open("GET", "/borrow?id=" + id, true)
                request.onreadystatechange = () =>{
                    console.log('2333')
                    if(request.readyState == 4)
                    {
                        if(request.responseText == "false")
                            alert("借书卡不存在")
                        else window.location.href = "/borrow?id=" + id
                    }
                }
                request.send()
            }
        }
    })

    let manager = new Vue({
            el : "#manager",
            methods : {
                pop : function() {
                    dialogue.show = true
                } 
            }
        }
    )

    let card = new Vue({
        el : "#card",
        methods : {
            pop : function(){
                borrow.show = true
            }
        }
    })
</script>